name: Falcon Sensor Automation and FCS CLI Image Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  scan-and-build:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # IaC Scan
    - name: Run FCS IaC Scan
      uses: crowdstrike/fcs-action@v3.0.0
      id: fcs-iac
      with:
        falcon_client_id: ${{ vars.FALCON_CLIENT_ID }}
        falcon_region: 'us-1'
        path: './terraform'
        report_formats: 'sarif,json'
        output_path: './iac-scan-results'
        upload_results: true
        version: 2.1.7
        project_name: 'my-awesome-project'
      env:
        FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

    # Build Docker Image
    - name: Build Docker Image
      id: build
      run: |
        docker build -t my-app:latest .
        FULL_ID=$(docker inspect --format='{{.Id}}' my-app:latest)
        echo "image_id=$FULL_ID" >> $GITHUB_OUTPUT
        echo "‚úÖ Built image: $FULL_ID"

    # Container Image Scan
    - name: Scan Container Image
      uses: crowdstrike/fcs-action@v3.0.0
      id: fcs-image
      with:
        falcon_client_id: ${{ vars.FALCON_CLIENT_ID }}
        falcon_region: 'us-1'
        scan_type: image
        image: my-app:latest
        output_path: './image-scan-results.json'
        report_formats: json,sarif
        upload_results: true
        version: 2.1.7
      env:
        FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

    # Upload SARIF to GitHub Code Scanning
    - name: Upload SARIF report
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: './image-scan-results.sarif'
        category: 'container-scan'

    # Continue pipeline only if scan passed
    - name: Push Image to Registry
      if: steps.fcs-image.outputs.exit-code == '0'
      run: |
        echo "‚úÖ Security scan passed - proceeding with image push"
        # Uncomment when ready to push
        # docker tag my-app:latest crmiked.azurecr.io/my-app:latest
        # docker push crmiked.azurecr.io/my-app:latest

    # Optional: Deploy or additional steps
    - name: Deploy Application
      if: steps.fcs-image.outputs.exit-code == '0'
      run: |
        echo "‚úÖ Deploying application..."
        # Add your deployment logic here

    # Workflow Summary
    - name: Workflow Summary
      if: always()
      run: |
        echo "## ü¶Ö Falcon Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### IaC Scan" >> $GITHUB_STEP_SUMMARY
        echo "- Exit Code: ${{ steps.fcs-iac.outputs.exit-code }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Container Image Scan" >> $GITHUB_STEP_SUMMARY
        echo "- Image: my-app:latest" >> $GITHUB_STEP_SUMMARY
        echo "- Image ID: ${{ steps.build.outputs.image_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- Exit Code: ${{ steps.fcs-image.outputs.exit-code }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.fcs-image.outputs.exit-code }}" == "0" ]; then
          echo "‚úÖ **Status**: Security checks passed - pipeline continued" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Status**: Security issues detected - pipeline halted" >> $GITHUB_STEP_SUMMARY
        fi

    # Fail the job if scan failed
    - name: Fail on Security Issues
      if: steps.fcs-image.outputs.exit-code != '0'
      run: |
        echo "‚ùå Security scan failed with exit code: ${{ steps.fcs-image.outputs.exit-code }}"
        echo "Please review the scan results and resolve security findings before proceeding"
        exit 1
