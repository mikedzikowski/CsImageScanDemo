- name: Convert JSON to SARIF
      run: |
        mkdir -p ./scan-results
        
        if [ -s "./scan-results/results.json" ]; then
          jq -n '
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Falcon Container Security",
                    "informationUri": "https://www.crowdstrike.com/",
                    "rules": [
                      {
                        "id": "container-security",
                        "shortDescription": {
                          "text": "Container Security Scan"
                        },
                        "fullDescription": {
                          "text": "Scans containers for security vulnerabilities"
                        },
                        "help": {
                          "text": "Container security scanning results from Falcon Container Security"
                        }
                      }
                    ]
                  }
                },
                "results": [inputs | .[] | select(.path != null) | {
                  "ruleId": "container-security",
                  "level": "warning",
                  "message": {
                    "text": ("Container file: " + .path + " | Size: " + (.size|tostring) + " | Permissions: " + .permissions)
                  },
                  "locations": [{
                    "physicalLocation": {
                      "artifactLocation": {
                        "uri": .path
                      },
                      "region": {
                        "startLine": 1,
                        "endLine": 1,
                        "startColumn": 1,
                        "endColumn": 1
                      }
                    }
                  }],
                  "partialFingerprints": {
                    "primaryLocationLineHash": (.path + .size|tostring)
                  }
                }]
              }
            ]
          }
          ' --slurpfile input ./scan-results/results.json > ./scan-results/scan.sarif

          # Validate SARIF file
          echo "Validating SARIF file..."
          if jq empty ./scan-results/scan.sarif; then
            echo "SARIF file is valid JSON"
          else
            echo "SARIF file is invalid JSON"
            exit 1
          fi
        else
          echo "No results found in results.json"
          exit 1
        fi

    - name: Debug SARIF Content
      run: |
        echo "SARIF file contents:"
        cat ./scan-results/scan.sarif
        echo "File size: $(stat -f%z ./scan-results/scan.sarif) bytes"
