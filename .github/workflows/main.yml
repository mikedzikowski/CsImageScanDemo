name: Falcon Sensor Automation and FCS CLI Image Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  scan-and-build:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Build Docker Image
    - name: Build Docker Image
      id: build
      run: |
        docker build -t rapidfort/curl:latest .
        FULL_ID=$(docker inspect --format='{{.Id}}' rapidfort/curl:latest)
        # Extract just the SHA256 hash without the sha256: prefix
        IMAGE_DIGEST=$(echo $FULL_ID | cut -d':' -f2)
        echo "image_id=$FULL_ID" >> $GITHUB_OUTPUT
        echo "image_digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT
        echo "‚úÖ Built image: $FULL_ID"
        echo "‚úÖ Image digest: $IMAGE_DIGEST"

    # Get Falcon OAuth2 Token
    - name: Get Falcon API Token
      id: falcon-token
      run: |
        TOKEN_RESPONSE=$(curl -X POST "https://api.us-1.crowdstrike.com/oauth2/token" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "client_id=${{ vars.FALCON_CLIENT_ID }}" \
          -d "client_secret=${{ secrets.FALCON_CLIENT_SECRET }}")
        
        ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
        
        if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
          echo "‚ùå Failed to obtain API token"
          echo $TOKEN_RESPONSE | jq '.'
          exit 1
        fi
        
        echo "::add-mask::$ACCESS_TOKEN"
        echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
        echo "‚úÖ Successfully obtained Falcon API token"

    # Create Image Assessment Policy
    - name: Create Image Assessment Policy
      id: create-policy
      run: |
        POLICY_NAME="github-workflow-${{ github.run_id }}"
        
        # Create policy
        POLICY_RESPONSE=$(curl -X POST \
          "https://api.us-1.crowdstrike.com/container-security/entities/policies/v1" \
          -H "Authorization: Bearer ${{ steps.falcon-token.outputs.access_token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "'"$POLICY_NAME"'",
            "description": "Auto-generated policy for GitHub workflow run ${{ github.run_id }} - Prevents deployment of vulnerable images"
          }')
        
        POLICY_ID=$(echo $POLICY_RESPONSE | jq -r '.resources[0].policy_id')
        
        if [ "$POLICY_ID" == "null" ] || [ -z "$POLICY_ID" ]; then
          echo "‚ùå Failed to create policy"
          echo $POLICY_RESPONSE | jq '.'
          exit 1
        fi
        
        echo "policy_id=$POLICY_ID" >> $GITHUB_OUTPUT
        echo "policy_name=$POLICY_NAME" >> $GITHUB_OUTPUT
        echo "‚úÖ Created policy: $POLICY_NAME (ID: $POLICY_ID)"

    # Create Image Group for the Built Image
    - name: Create Image Group
      id: create-image-group
      run: |
        IMAGE_GROUP_NAME="github-image-group-${{ github.run_id }}"
        
        # Create image group targeting the specific image by digest
        IMAGE_GROUP_RESPONSE=$(curl -X POST \
          "https://api.us-1.crowdstrike.com/container-security/entities/policy-groups/v1" \
          -H "Authorization: Bearer ${{ steps.falcon-token.outputs.access_token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "'"$IMAGE_GROUP_NAME"'",
            "description": "Image group for built image in workflow ${{ github.run_id }}",
            "policy_id": "'"${{ steps.create-policy.outputs.policy_id }}"'",
            "policy_group_data": {
              "conditions": [
                {
                  "prop": "image_id",
                  "value": ["'"${{ steps.build.outputs.image_digest }}"'"]
                }
              ]
            }
          }')
        
        IMAGE_GROUP_ID=$(echo $IMAGE_GROUP_RESPONSE | jq -r '.resources[0].policy_group_id')
        
        if [ "$IMAGE_GROUP_ID" == "null" ] || [ -z "$IMAGE_GROUP_ID" ]; then
          echo "‚ùå Failed to create image group"
          echo $IMAGE_GROUP_RESPONSE | jq '.'
          exit 1
        fi
        
        echo "image_group_id=$IMAGE_GROUP_ID" >> $GITHUB_OUTPUT
        echo "image_group_name=$IMAGE_GROUP_NAME" >> $GITHUB_OUTPUT
        echo "‚úÖ Created image group: $IMAGE_GROUP_NAME (ID: $IMAGE_GROUP_ID)"

    # Update Policy with Comprehensive Rules (matching screenshot)
    - name: Configure Policy Rules
      id: configure-policy
      run: |
        # Update policy with comprehensive vulnerability rules
        POLICY_UPDATE_RESPONSE=$(curl -X PATCH \
          "https://api.us-1.crowdstrike.com/container-security/entities/policies/v1?id=${{ steps.create-policy.outputs.policy_id }}" \
          -H "Authorization: Bearer ${{ steps.falcon-token.outputs.access_token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "'"${{ steps.create-policy.outputs.policy_name }}"'",
            "description": "Auto-generated policy for GitHub workflow run ${{ github.run_id }} - Prevents deployment of vulnerable images",
            "is_enabled": true,
            "policy_data": {
              "rules": [
                {
                  "action": "block",
                  "policy_rules_data": {
                    "conditions": [
                      {
                        "prop": "cve_exploited_status",
                        "value": ["ACTIVELY_USED"]
                      },
                      {
                        "prop": "detection_severity",
                        "value": ["CRITICAL", "HIGH"]
                      },
                      {
                        "prop": "vulnerability_exprt_severity",
                        "value": ["CRITICAL", "HIGH"]
                      },
                      {
                        "prop": "cve_severity",
                        "value": ["CRITICAL", "HIGH"]
                      },
                      {
                        "prop": "detection_type",
                        "value": ["Image misconfigurations", "Malware", "Secrets", "Malicious code", "Suspicious file"]
                      },
                      {
                        "prop": "vulnerability_is_exploitable",
                        "value": ["YES"]
                      }
                    ]
                  }
                }
              ]
            }
          }')
        
        UPDATED_POLICY=$(echo $POLICY_UPDATE_RESPONSE | jq -r '.resources[0].policy_id')
        
        if [ "$UPDATED_POLICY" == "null" ] || [ -z "$UPDATED_POLICY" ]; then
          echo "‚ùå Failed to update policy rules"
          echo $POLICY_UPDATE_RESPONSE | jq '.'
          exit 1
        fi
        
        echo "‚úÖ Configured policy rules successfully"
        echo "Policy details:"
        echo $POLICY_UPDATE_RESPONSE | jq '.resources[0]'

    # Wait for policy to propagate
    - name: Wait for Policy Propagation
      run: |
        echo "‚è≥ Waiting for policy to propagate..."
        sleep 10

    # Container Image Scan with Policy Enforcement
    - name: Scan Container Image
      uses: crowdstrike/fcs-action@v3.0.0
      id: fcs-image
      with:
        falcon_client_id: ${{ vars.FALCON_CLIENT_ID }}
        falcon_region: 'us-1'
        scan_type: image
        image: rapidfort/curl:latest
        output_path: './image-scan-results.json'
        report_formats: json,sarif
        upload_results: true
        version: 2.1.7
      env:
        FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

    # Upload SARIF to GitHub Code Scanning
    - name: Upload SARIF report
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: './image-scan-results.sarif'
        category: 'container-scan'

    # Extract vulnerability counts from scan results
    - name: Parse Scan Results
      if: always()
      id: parse-results
      run: |
        if [ -f "./image-scan-results.json" ]; then
          CRITICAL_VULNS=$(jq -r '.vulnerabilities.critical // 0' ./image-scan-results.json)
          HIGH_VULNS=$(jq -r '.vulnerabilities.high // 0' ./image-scan-results.json)
          MEDIUM_VULNS=$(jq -r '.vulnerabilities.medium // 0' ./image-scan-results.json)
          LOW_VULNS=$(jq -r '.vulnerabilities.low // 0' ./image-scan-results.json)
          DETECTIONS=$(jq -r '.detections // 0' ./image-scan-results.json)
          
          echo "critical_vulns=$CRITICAL_VULNS" >> $GITHUB_OUTPUT
          echo "high_vulns=$HIGH_VULNS" >> $GITHUB_OUTPUT
          echo "medium_vulns=$MEDIUM_VULNS" >> $GITHUB_OUTPUT
          echo "low_vulns=$LOW_VULNS" >> $GITHUB_OUTPUT
          echo "detections=$DETECTIONS" >> $GITHUB_OUTPUT
        else
          echo "critical_vulns=0" >> $GITHUB_OUTPUT
          echo "high_vulns=0" >> $GITHUB_OUTPUT
          echo "medium_vulns=0" >> $GITHUB_OUTPUT
          echo "low_vulns=0" >> $GITHUB_OUTPUT
          echo "detections=0" >> $GITHUB_OUTPUT
        fi

    # Continue pipeline only if scan passed (exit code 0)
    - name: Push Image to Registry
      if: steps.fcs-image.outputs.exit-code == '0'
      run: |
        echo "‚úÖ Security scan passed - proceeding with image push"
        echo "Image meets security policy requirements"
        # Uncomment when ready to push
        # docker tag rapidfort/curl:latest youracr.azurecr.io/rapidfort/curl:latest
        # docker push youracr.azurecr.io/rapidfort/curl:latest

    # Optional: Deploy or additional steps
    - name: Deploy Application
      if: steps.fcs-image.outputs.exit-code == '0'
      run: |
        echo "‚úÖ Deploying application..."
        echo "Image has been validated against security policies"
        # Add your deployment logic here

    # Cleanup: Delete the policy and image group
    - name: Cleanup Policy Resources
      if: always()
      run: |
        # Delete image group
        if [ -n "${{ steps.create-image-group.outputs.image_group_id }}" ]; then
          curl -X DELETE \
            "https://api.us-1.crowdstrike.com/container-security/entities/policy-groups/v1?id=${{ steps.create-image-group.outputs.image_group_id }}" \
            -H "Authorization: Bearer ${{ steps.falcon-token.outputs.access_token }}"
          echo "‚úÖ Deleted image group: ${{ steps.create-image-group.outputs.image_group_name }}"
        fi
        
        # Delete policy
        if [ -n "${{ steps.create-policy.outputs.policy_id }}" ]; then
          curl -X DELETE \
            "https://api.us-1.crowdstrike.com/container-security/entities/policies/v1?id=${{ steps.create-policy.outputs.policy_id }}" \
            -H "Authorization: Bearer ${{ steps.falcon-token.outputs.access_token }}"
          echo "‚úÖ Deleted policy: ${{ steps.create-policy.outputs.policy_name }}"
        fi

    # Workflow Summary
    - name: Workflow Summary
      if: always()
      run: |
        echo "## ü¶Ö Falcon Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üèóÔ∏è Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: rapidfort/curl:latest" >> $GITHUB_STEP_SUMMARY
        echo "- **Image ID**: ${{ steps.build.outputs.image_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Digest**: ${{ steps.build.outputs.image_digest }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìã Policy Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Policy Name**: ${{ steps.create-policy.outputs.policy_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Policy ID**: ${{ steps.create-policy.outputs.policy_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Group**: ${{ steps.create-image-group.outputs.image_group_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîç Policy Rules Applied" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úã **Action**: BLOCK" >> $GITHUB_STEP_SUMMARY
        echo "- üéØ **Vulnerability Exploited Status**: Actively used" >> $GITHUB_STEP_SUMMARY
        echo "- üö® **Detection Severity**: Critical, High" >> $GITHUB_STEP_SUMMARY
        echo "- ü§ñ **Vulnerability ExPRT.ai Severities**: Critical, High" >> $GITHUB_STEP_SUMMARY
        echo "- ‚ö†Ô∏è  **Vulnerability Severity**: Critical, High" >> $GITHUB_STEP_SUMMARY
        echo "- üîß **Detection Types**: Image misconfigurations, Malware, Secrets, Malicious code, Suspicious file" >> $GITHUB_STEP_SUMMARY
        echo "- üí• **Vulnerability is Exploitable**: Yes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Exit Code**: ${{ steps.fcs-image.outputs.exit-code }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üêõ Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
        echo "- üî¥ **Critical**: ${{ steps.parse-results.outputs.critical_vulns }}" >> $GITHUB_STEP_SUMMARY
        echo "- üü† **High**: ${{ steps.parse-results.outputs.high_vulns }}" >> $GITHUB_STEP_SUMMARY
        echo "- üü° **Medium**: ${{ steps.parse-results.outputs.medium_vulns }}" >> $GITHUB_STEP_SUMMARY
        echo "- üü¢ **Low**: ${{ steps.parse-results.outputs.low_vulns }}" >> $GITHUB_STEP_SUMMARY
        echo "- üîç **Detections**: ${{ steps.parse-results.outputs.detections }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.fcs-image.outputs.exit-code }}" == "0" ]; then
          echo "‚úÖ **Status**: Security checks passed - pipeline continued" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The image meets all security policy requirements and is approved for deployment." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Status**: Security issues detected - pipeline halted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The image violates security policies and cannot be deployed. Please review and remediate the findings." >> $GITHUB_STEP_SUMMARY
        fi

    # Fail the job if scan failed (exit code != 0)
    - name: Fail on Security Issues
      if: steps.fcs-image.outputs.exit-code != '0'
      run: |
        echo "‚ùå Security scan failed - Image blocked by policy"
        echo ""
        echo "Exit Code: ${{ steps.fcs-image.outputs.exit-code }}"
        echo "Detections: ${{ steps.parse-results.outputs.detections }}"
        echo ""
        echo "Vulnerabilities:"
        echo "  Critical: ${{ steps.parse-results.outputs.critical_vulns }}"
        echo "  High: ${{ steps.parse-results.outputs.high_vulns }}"
        echo "  Medium: ${{ steps.parse-results.outputs.medium_vulns }}"
        echo "  Low: ${{ steps.parse-results.outputs.low_vulns }}"
        echo ""
        echo "Please review the scan results and resolve security findings before proceeding"
        exit 1
